{% comment %}
  Estelle Atelier - Parallax Slideshow Section
  Immersive slideshow with parallax scrolling effect
{% endcomment %}

{% stylesheet %}
  .parallax-slideshow {
    position: relative;
    height: {{ section.settings.section_height }};
    min-height: 500px;
    overflow: hidden;
  }
  .parallax-slide {
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity 1s ease-in-out;
  }
  .parallax-slide.active {
    opacity: 1;
  }
  .parallax-slide img {
    transform: translateY(var(--parallax-offset, 0));
    transition: transform 0.1s linear;
  }
  .parallax-nav-dot {
    transition: all 0.3s ease;
  }
  .parallax-nav-dot.active {
    width: 2rem;
    background-color: white;
  }
{% endstylesheet %}

<div class="parallax-slideshow" data-section-id="{{ section.id }}" data-autoplay="{{ section.settings.autoplay }}" data-delay="{{ section.settings.autoplay_delay }}">
  {% for block in section.blocks %}
    <div
      class="parallax-slide {% if forloop.first %}active{% endif %}"
      data-slide-index="{{ forloop.index0 }}"
      {{ block.shopify_attributes }}
    >
      {% if block.settings.image != blank %}
        {{
          block.settings.image
          | image_tag:
            class: 'absolute inset-0 w-full h-full object-cover',
            loading: '{% if forloop.first %}eager{% else %}lazy{% endif %}',
            widths: '750, 1000, 1500, 1920, 2500, 3000, 3840',
            sizes: '100vw'
        }}
      {% else %}
        {{ 'lifestyle-1' | placeholder_svg_tag: 'absolute inset-0 w-full h-full bg-sage-pale' }}
      {% endif %}

      <!-- Overlay -->
      <div class="absolute inset-0 bg-black/{{ block.settings.overlay_opacity }}"></div>

      <!-- Content -->
      <div class="absolute inset-0 flex items-center justify-center p-6">
        <div class="text-center max-w-4xl">
          {% if block.settings.overline != blank %}
            <span class="text-sage-dark text-xs font-bold uppercase tracking-[0.3em] mb-4 block animate-entrance">
              {{ block.settings.overline }}
            </span>
          {% endif %}

          {% if block.settings.heading != blank %}
            <h2 class="text-white text-4xl md:text-6xl lg:text-7xl font-bold tracking-tight mb-6 serif animate-entrance delay-100">
              {{ block.settings.heading }}
            </h2>
          {% endif %}

          {% if block.settings.text != blank %}
            <p class="text-white/90 text-lg md:text-xl font-light mb-8 animate-entrance delay-200">
              {{ block.settings.text }}
            </p>
          {% endif %}

          {% if block.settings.button_label != blank and block.settings.button_link != blank %}
            <a
              href="{{ block.settings.button_link }}"
              class="inline-flex items-center gap-2 bg-white text-text-olive-deep px-8 py-4 rounded-lg text-sm font-bold uppercase tracking-widest hover:bg-sage-pale transition-all animate-entrance delay-300"
            >
              {{ block.settings.button_label }}
              <span class="material-symbols-outlined text-lg">arrow_forward</span>
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}

  <!-- Navigation Dots -->
  {% if section.settings.show_nav_dots and section.blocks.size > 1 %}
    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-3 z-20">
      {% for block in section.blocks %}
        <button
          data-dot-index="{{ forloop.index0 }}"
          class="parallax-nav-dot w-3 h-3 rounded-full {% if forloop.first %}active{% endif %} bg-white/40 hover:bg-white/60"
          aria-label="{{ 'accessibility.go_to_slide' | t: index: forloop.index }}"
        ></button>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Navigation Arrows -->
  {% if section.settings.show_arrows and section.blocks.size > 1 %}
    <button data-parallax-prev class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 flex items-center justify-center bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full text-white transition-all z-20">
      <span class="material-symbols-outlined">chevron_left</span>
    </button>
    <button data-parallax-next class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 flex items-center justify-center bg-white/10 hover:bg-white/20 backdrop-blur-sm rounded-full text-white transition-all z-20">
      <span class="material-symbols-outlined">chevron_right</span>
    </button>
  {% endif %}
</div>

{% javascript %}
  (function() {
    'use strict';

    const container = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!container) return;

    const slides = container.querySelectorAll('.parallax-slide');
    const dots = container.querySelectorAll('[data-dot-index]');
    const prevBtn = container.querySelector('[data-parallax-prev]');
    const nextBtn = container.querySelector('[data-parallax-next]');
    const autoplay = container.dataset.autoplay === 'true';
    const delay = parseInt(container.dataset.delay) || 5000;

    let currentSlide = 0;
    let autoplayInterval;

    function showSlide(index) {
      if (index < 0) index = slides.length - 1;
      if (index >= slides.length) index = 0;

      slides.forEach((slide, i) => {
        slide.classList.toggle('active', i === index);
      });

      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });

      currentSlide = index;
    }

    function nextSlide() {
      showSlide(currentSlide + 1);
    }

    function prevSlide() {
      showSlide(currentSlide - 1);
    }

    // Navigation
    if (prevBtn) prevBtn.addEventListener('click', prevSlide);
    if (nextBtn) nextBtn.addEventListener('click', nextSlide);

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => showSlide(index));
    });

    // Autoplay
    if (autoplay && slides.length > 1) {
      autoplayInterval = setInterval(nextSlide, delay);
      container.addEventListener('mouseenter', () => clearInterval(autoplayInterval));
      container.addEventListener('mouseleave', () => autoplayInterval = setInterval(nextSlide, delay));
    }

    // Keyboard navigation
    container.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') prevSlide();
      if (e.key === 'ArrowRight') nextSlide();
    });

    // Parallax effect on scroll
    window.addEventListener('scroll', () => {
      const rect = container.getBoundingClientRect();
      const scrolled = window.scrollY;
      const rate = scrolled * 0.3;

      slides.forEach(slide => {
        const img = slide.querySelector('img');
        if (img && rect.top < window.innerHeight && rect.bottom > 0) {
          img.style.setProperty('--parallax-offset', `${rate}px`);
        }
      });
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Parallax Slideshow",
  "tag": "section",
  "class": "section-parallax-slideshow",
  "settings": [
    {
      "type": "select",
      "id": "section_height",
      "label": "Section height",
      "options": [
        {
          "value": "60vh",
          "label": "60% viewport height"
        },
        {
          "value": "70vh",
          "label": "70% viewport height"
        },
        {
          "value": "80vh",
          "label": "80% viewport height"
        },
        {
          "value": "90vh",
          "label": "90% viewport height"
        },
        {
          "value": "100vh",
          "label": "Full viewport height"
        }
      ],
      "default": "90vh"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Auto-rotate slides",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_delay",
      "min": 2000,
      "max": 10000,
      "step": 1000,
      "default": 5000,
      "unit": "ms",
      "label": "Change slides every"
    },
    {
      "type": "checkbox",
      "id": "show_nav_dots",
      "label": "Show navigation dots",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show navigation arrows",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "range",
          "id": "overlay_opacity",
          "min": 0,
          "max": 80,
          "step": 5,
          "default": 40,
          "unit": "%",
          "label": "Overlay opacity"
        },
        {
          "type": "text",
          "id": "overline",
          "label": "Overline",
          "default": "New Collection"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Heading",
          "default": "The Art of Sustainable Luxury"
        },
        {
          "type": "textarea",
          "id": "text",
          "label": "Text",
          "default": "Discover our latest collection crafted from ethically sourced materials."
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button label",
          "default": "Explore Collection"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Button link",
          "default": "/collections/all"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Parallax Slideshow",
      "category": "Hero",
      "blocks": [
        {
          "type": "slide"
        },
        {
          "type": "slide"
        },
        {
          "type": "slide"
        }
      ]
    }
  ]
}
{% endschema %}
